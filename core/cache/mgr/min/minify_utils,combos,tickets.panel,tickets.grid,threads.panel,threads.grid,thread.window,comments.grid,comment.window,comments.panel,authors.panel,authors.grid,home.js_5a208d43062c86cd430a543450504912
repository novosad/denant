Date.ext={};Date.ext.util={};Date.ext.util.xPad=function(x,pad,r){if(typeof(r)=="undefined"){r=10}for(;parseInt(x,10)<r&&r>1;r/=10){x=pad.toString()+x}return x.toString()};Date.prototype.locale="en-GB";if(document.getElementsByTagName("html")&&document.getElementsByTagName("html")[0].lang){Date.prototype.locale=document.getElementsByTagName("html")[0].lang}Date.ext.locales={};Date.ext.locales.en={a:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],A:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],B:["January","February","March","April","May","June","July","August","September","October","November","December"],c:"%a %d %b %Y %T %Z",p:["AM","PM"],P:["am","pm"],x:"%d/%m/%y",X:"%T"};Date.ext.locales["en-US"]=Date.ext.locales.en;Date.ext.locales["en-US"].c="%a %d %b %Y %r %Z";Date.ext.locales["en-US"].x="%D";Date.ext.locales["en-US"].X="%r";Date.ext.locales["en-GB"]=Date.ext.locales.en;Date.ext.locales["en-AU"]=Date.ext.locales["en-GB"];Date.ext.formats={a:function(d){return Date.ext.locales[d.locale].a[d.getDay()]},A:function(d){return Date.ext.locales[d.locale].A[d.getDay()]},b:function(d){return Date.ext.locales[d.locale].b[d.getMonth()]},B:function(d){return Date.ext.locales[d.locale].B[d.getMonth()]},c:"toLocaleString",C:function(d){return Date.ext.util.xPad(parseInt(d.getFullYear()/100,10),0)},d:["getDate","0"],e:["getDate"," "],g:function(d){return Date.ext.util.xPad(parseInt(Date.ext.util.G(d)/100,10),0)},G:function(d){var y=d.getFullYear();var V=parseInt(Date.ext.formats.V(d),10);var W=parseInt(Date.ext.formats.W(d),10);if(W>V){y++}else{if(W===0&&V>=52){y--}}return y},H:["getHours","0"],I:function(d){var I=d.getHours()%12;return Date.ext.util.xPad(I===0?12:I,0)},j:function(d){var ms=d-new Date(""+d.getFullYear()+"/1/1 GMT");ms+=d.getTimezoneOffset()*60000;var doy=parseInt(ms/60000/60/24,10)+1;return Date.ext.util.xPad(doy,0,100)},m:function(d){return Date.ext.util.xPad(d.getMonth()+1,0)},M:["getMinutes","0"],p:function(d){return Date.ext.locales[d.locale].p[d.getHours()>=12?1:0]},P:function(d){return Date.ext.locales[d.locale].P[d.getHours()>=12?1:0]},S:["getSeconds","0"],u:function(d){var dow=d.getDay();return dow===0?7:dow},U:function(d){var doy=parseInt(Date.ext.formats.j(d),10);var rdow=6-d.getDay();var woy=parseInt((doy+rdow)/7,10);return Date.ext.util.xPad(woy,0)},V:function(d){var woy=parseInt(Date.ext.formats.W(d),10);var dow1_1=(new Date(""+d.getFullYear()+"/1/1")).getDay();var idow=woy+(dow1_1>4||dow1_1<=1?0:1);if(idow==53&&(new Date(""+d.getFullYear()+"/12/31")).getDay()<4){idow=1}else{if(idow===0){idow=Date.ext.formats.V(new Date(""+(d.getFullYear()-1)+"/12/31"))}}return Date.ext.util.xPad(idow,0)},w:"getDay",W:function(d){var doy=parseInt(Date.ext.formats.j(d),10);var rdow=7-Date.ext.formats.u(d);var woy=parseInt((doy+rdow)/7,10);return Date.ext.util.xPad(woy,0,10)},y:function(d){return Date.ext.util.xPad(d.getFullYear()%100,0)},Y:"getFullYear",z:function(d){var o=d.getTimezoneOffset();var H=Date.ext.util.xPad(parseInt(Math.abs(o/60),10),0);var M=Date.ext.util.xPad(o%60,0);return(o>0?"-":"+")+H+M},Z:function(d){return d.toString().replace(/^.*\(([^)]+)\)$/,"$1")},"%":function(d){return"%"}};Date.ext.aggregates={c:"locale",D:"%m/%d/%y",h:"%b",n:"\n",r:"%I:%M:%S %p",R:"%H:%M",t:"\t",T:"%H:%M:%S",x:"locale",X:"locale"};Date.ext.aggregates.z=Date.ext.formats.z(new Date());Date.ext.aggregates.Z=Date.ext.formats.Z(new Date());Date.ext.unsupported={};Date.prototype.strftime=function(fmt){if(!(this.locale in Date.ext.locales)){if(this.locale.replace(/-[a-zA-Z]+$/,"")in Date.ext.locales){this.locale=this.locale.replace(/-[a-zA-Z]+$/,"")}else{this.locale="en-GB"}}var d=this;while(fmt.match(/%[cDhnrRtTxXzZ]/)){fmt=fmt.replace(/%([cDhnrRtTxXzZ])/g,function(m0,m1){var f=Date.ext.aggregates[m1];return(f=="locale"?Date.ext.locales[d.locale][m1]:f)})}var str=fmt.replace(/%([aAbBCdegGHIjmMpPSuUVwWyY%])/g,function(m0,m1){var f=Date.ext.formats[m1];if(typeof(f)=="string"){return d[f]()}else{if(typeof(f)=="function"){return f.call(d,d)}else{if(typeof(f)=="object"&&typeof(f[0])=="string"){return Date.ext.util.xPad(d[f[0]](),f[1])}else{return m1}}}});d=null;return str};Tickets.utils.formatDate=function(string){if(string&&string!='0000-00-00 00:00:00'&&string!='-1-11-30 00:00:00'&&string!=0){var date=/^[0-9]+$/.test(string)?new Date(string*1000):new Date(string.replace(/(\d+)-(\d+)-(\d+)/,'$2/$3/$1'));return date.strftime(MODx.config['tickets.date_format']);}
else{return'&nbsp;';}};Tickets.utils.userLink=function(value,id){if(!value){return'';}
else if(!id){return value;}
var action=MODx.action?MODx.action['security/user/update']:'security/user/update';var url='index.php?a='+action+'&id='+id;return'<a href="'+url+'" target="_blank" class="tickets-link">'+value+'</a>'};Tickets.utils.ticketLink=function(value,id,blank){if(!value){return'';}
else if(!id){return value;}
var action=MODx.action?MODx.action['resource/update']:'resource/update';var url='index.php?a='+action+'&id='+id;return blank?'<a href="'+url+'" class="tickets-link" target="_blank">'+value+'</a>':'<a href="'+url+'" class="tickets-link">'+value+'</a>';};Tickets.utils.getMenu=function(actions,grid,selected){var menu=[];var cls,icon,title,action='';var has_delete=false;for(var i in actions){if(!actions.hasOwnProperty(i)){continue;}
var a=actions[i];if(!a['menu']){if(a=='-'){menu.push('-');}
continue;}
else if(menu.length>0&&!has_delete&&(/^remove/i.test(a['action'])||/^delete/i.test(a['action']))){menu.push('-');has_delete=true;}
if(selected.length>1){if(!a['multiple']){continue;}
else if(typeof(a['multiple'])=='string'){a['title']=a['multiple'];}}
cls=a['cls']?a['cls']:'';icon=a['icon']?a['icon']:'';title=a['title']?a['title']:a['title'];action=a['action']?grid[a['action']]:'';menu.push({handler:action,text:String.format('<span class="{0}"><i class="x-menu-item-icon {1}"></i>{2}</span>',cls,icon,title),});}
return menu;};Tickets.utils.renderActions=function(value,props,row){var res=[];var cls,icon,title,action,item='';for(var i in row.data.actions){if(!row.data.actions.hasOwnProperty(i)){continue;}
var a=row.data.actions[i];if(!a['button']){continue;}
cls=a['cls']?a['cls']:'';icon=a['icon']?a['icon']:'';action=a['action']?a['action']:'';title=a['title']?a['title']:'';item=String.format('<li class="{0}"><button class="btn btn-default {1}" action="{2}" title="{3}"></button></li>',cls,icon,action,title);res.push(item);}
return String.format('<ul class="tickets-row-actions">{0}</ul>',res.join(''));};;Tickets.combo.User=function(config){config=config||{};Ext.applyIf(config,{name:'user',fieldLabel:config.name||'createdby',hiddenName:config.name||'createdby',displayField:'username',valueField:'id',anchor:'99%',fields:['username','id','fullname'],pageSize:20,url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'security/user.php',typeAhead:false,editable:true,allowBlank:false,baseParams:{action:MODx.modx23?'security/user/getlist':'getlist',combo:1,id:config.value},tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <span>\
      <small>({id})</small>\
      <b>{username}</b>\
      <tpl if="fullname"> - {fullname}</tpl>\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});Tickets.combo.User.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.User,MODx.combo.ComboBox);Ext.reg('tickets-combo-user',Tickets.combo.User);MODx.combo.TicketsSection=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('resource_parent'),description:'<b>[[*parent]]</b><br />'+_('resource_parent_help'),fields:['id','pagetitle','parents'],valueField:'id',displayField:'pagetitle',name:'parent-cmb',hiddenName:'parent-cmp',url:Tickets.config.connector_url,baseParams:{action:'mgr/section/getlist',combo:1,id:config.value},pageSize:10,width:300,typeAhead:false,editable:true,allowBlank:false,tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <tpl if="parents">\
      <span class="parents">\
       <tpl for="parents">\
        <nobr>{pagetitle} / </nobr>\
       </tpl>\
      </span>\
     </tpl>\
     <span>\
      <small>({id})</small>\
      <b>{pagetitle}</b>\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});MODx.combo.TicketsSection.superclass.constructor.call(this,config);};Ext.extend(MODx.combo.TicketsSection,MODx.combo.ComboBox);Ext.reg('tickets-combo-section',MODx.combo.TicketsSection);Tickets.combo.TicketThread=function(config){config=config||{};Ext.applyIf(config,{fieldLabel:_('ticket_thread'),fields:['id','name','pagetitle'],valueField:'id',displayField:'name',name:'thread',hiddenName:'thread',url:Tickets.config.connector_url,baseParams:{action:'mgr/thread/getlist',combo:1,id:config.value},pageSize:10,width:300,typeAhead:false,editable:true,allowBlank:false,tpl:new Ext.XTemplate('\
   <tpl for=".">\
    <div class="x-combo-list-item tickets-list-item">\
     <span>\
      <small>({id})</small>\
      <b>{name}</b> - {pagetitle}\
     </span>\
    </div>\
   </tpl>',{compiled:true}),});Tickets.combo.TicketThread.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.TicketThread,MODx.combo.ComboBox);Ext.reg('tickets-combo-thread',Tickets.combo.TicketThread);Tickets.combo.Template=function(config){config=config||{};Ext.applyIf(config,{name:'properties[tickets][template]',hiddenName:'properties[tickets][template]',url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'element/template.php',baseParams:{action:MODx.modx23?'element/template/getlist':'getlist',combo:1,}});Tickets.combo.Template.superclass.constructor.call(this,config);};Ext.extend(Tickets.combo.Template,MODx.combo.Template);Ext.reg('tickets-children-combo-template',Tickets.combo.Template);Tickets.combo.Search=function(config){config=config||{};Ext.applyIf(config,{xtype:'twintrigger',ctCls:'x-field-search',allowBlank:true,msgTarget:'under',emptyText:_('search'),name:'query',triggerAction:'all',clearBtnCls:'x-field-search-clear',searchBtnCls:'x-field-search-go',onTrigger1Click:this._triggerSearch,onTrigger2Click:this._triggerClear,});Tickets.combo.Search.superclass.constructor.call(this,config);this.on('render',function(){this.getEl().addKeyListener(Ext.EventObject.ENTER,function(){this._triggerSearch();},this);});this.addEvents('clear','search');};Ext.extend(Tickets.combo.Search,Ext.form.TwinTriggerField,{initComponent:function(){Ext.form.TwinTriggerField.superclass.initComponent.call(this);this.triggerConfig={tag:'span',cls:'x-field-search-btns',cn:[{tag:'div',cls:'x-form-trigger '+this.searchBtnCls},{tag:'div',cls:'x-form-trigger '+this.clearBtnCls}]};},_triggerSearch:function(){this.fireEvent('search',this);},_triggerClear:function(){this.fireEvent('clear',this);},});Ext.reg('tickets-field-search',Tickets.combo.Search);;Tickets.panel.Tickets=function(config){config=config||{};if(typeof config.standalone=='undefined'){config.standalone=true;}
Ext.applyIf(config,{layout:'anchor',border:false,anchor:'100%',items:[{xtype:'tickets-grid-tickets',cls:'main-wrapper',standalone:config.standalone,parent:config.parent||0,}],cls:MODx.modx23?'modx23':'modx22',});Tickets.panel.Tickets.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Tickets,MODx.Panel);Ext.reg('tickets-panel-tickets',Tickets.panel.Tickets);;Tickets.grid.Section=function(config){config=config||{};Ext.applyIf(config,{url:Tickets.config.connector_url,baseParams:{action:'mgr/ticket/getlist',parent:config.parent||0,},fields:this.getFields(),columns:this.getColumns(config),tbar:this.getTopBar(config),sm:new Ext.grid.CheckboxSelectionModel(),autoHeight:true,paging:true,remoteSort:true,viewConfig:{forceFit:true,enableRowBody:true,autoFill:true,showPreview:true,scrollOffset:0,getRowClass:function(rec,ri,p){var cls=[];if(!rec.data.published){cls.push('tickets-row-unpublished');}
if(rec.data.deleted){cls.push('tickets-row-deleted');}
return cls.join(' ');}},cls:MODx.modx23?'modx23':'modx22',standalone:false,stateful:true,stateId:'tickets-grid-state',});Tickets.grid.Section.superclass.constructor.call(this,config);this.getStore().sortInfo={field:'createdon',direction:'DESC'};};Ext.extend(Tickets.grid.Section,MODx.grid.Grid,{getFields:function(config){return['id','pagetitle','published','deleted','publishedon','createdon','createdby','author','section_id','section','preview_url','comments','actions'];},getColumns:function(config){return[{header:_('id'),dataIndex:'id',width:35,sortable:true,},{header:_('ticket_pagetitle'),dataIndex:'pagetitle',width:config.standalone?100:150,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.ticketLink(value,record['data']['id'])},id:'pagetitle'},{header:_('ticket_createdon'),dataIndex:'createdon',width:50,sortable:true,renderer:Tickets.utils.formatDate,},{header:_('ticket_publishedon'),dataIndex:'publishedon',width:50,sortable:true,renderer:Tickets.utils.formatDate,},{header:_('ticket_author'),dataIndex:'author',width:75,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.userLink(value,record['data']['createdby'])},},{header:_('ticket_comments'),dataIndex:'comments',width:50,sortable:true,},{header:_('ticket_parent'),dataIndex:'section',width:75,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.ticketLink(value,record['data']['section_id'],true)},hidden:!config.standalone},{header:_('ticket_actions'),dataIndex:'actions',renderer:Tickets.utils.renderActions,sortable:false,width:75,id:'actions'}];},getTopBar:function(config){var tbar=[];if(!config.standalone){tbar.push({text:(MODx.modx23?'<i class="icon icon-plus"></i> ':'<i class="fa fa-plus"></i> ')
+_('ticket_create'),handler:this.createTicket,scope:this,});}
tbar.push({text:MODx.modx23?'<i class="icon icon-trash-o action-red"></i>':'<i class="fa fa-trash-o action-red"></i>',handler:this._emptyRecycleBin,scope:this,});tbar.push('->');tbar.push({xtype:'tickets-field-search',width:250,listeners:{search:{fn:function(field){this._doSearch(field);},scope:this},clear:{fn:function(field){field.setValue('');this._clearSearch();},scope:this},}});return tbar;},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=Tickets.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
else if(elem.nodeName=='A'&&elem.href.match(/(\?|\&)a=resource/)){if(e.button==1||(e.button==0&&e.ctrlKey==true)){}
else if(elem.target&&elem.target=='_blank'){}
else{e.preventDefault();MODx.loadPage('',elem.href);}}
return this.processEvent('click',e);},createTicket:function(){var createPage=MODx.action?MODx.action['resource/create']:'resource/create';location.href='index.php?a='+createPage+'&class_key=Ticket&parent='+MODx.request.id+'&context_key='+MODx.ctx;},editTicket:function(){var action=MODx.action?MODx.action['resource/update']:'resource/update';MODx.loadPage(action,'id='+this.menu.record.id);},viewTicket:function(){window.open(this.menu.record['preview_url']);return false;},ticketAction:function(method){var ids=this._getSelectedIds();if(!ids.length){return false;}
MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/ticket/multiple',method:method,ids:Ext.util.JSON.encode(ids),},listeners:{success:{fn:function(){this.refresh();},scope:this},failure:{fn:function(response){MODx.msg.alert(_('error'),response.message);},scope:this},}})},deleteTicket:function(btn,e){this.ticketAction('delete');},undeleteTicket:function(btn,e){this.ticketAction('undelete');},publishTicket:function(btn,e){this.ticketAction('publish');},unpublishTicket:function(btn,e){this.ticketAction('unpublish');},duplicateTicket:function(btn,e){var r=this.menu.record;var w=MODx.load({xtype:'modx-window-resource-duplicate',resource:r.id,hasChildren:0,listeners:{success:{fn:function(){this.refresh();},scope:this}}});w.config.hasChildren=0;w.setValues(r.data);w.show();},_getSelectedIds:function(){var ids=[];var selected=this.getSelectionModel().getSelections();for(var i in selected){if(!selected.hasOwnProperty(i)){continue;}
ids.push(selected[i]['id']);}
return ids;},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);},_clearSearch:function(){this.getStore().baseParams.query='';this.getBottomToolbar().changePage(1);},_emptyRecycleBin:function(){MODx.msg.confirm({title:_('empty_recycle_bin'),text:_('empty_recycle_bin_confirm'),url:MODx.modx23?MODx.config.connector_url:MODx.config.connectors_url+'resource/index.php',params:{action:MODx.modx23?'resource/emptyRecycleBin':'emptyRecycleBin',},listeners:{success:{fn:function(){this.refresh();},scope:this}}});},});Ext.reg('tickets-grid-tickets',Tickets.grid.Section);;Tickets.panel.Threads=function(config){config=config||{};Ext.applyIf(config,{layout:'anchor',border:false,anchor:'100%',items:[{xtype:'tickets-grid-threads',cls:'main-wrapper',}],cls:MODx.modx23?'modx23':'modx22',});Tickets.panel.Threads.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Threads,MODx.Panel);Ext.reg('tickets-panel-threads',Tickets.panel.Threads);;Tickets.grid.Threads=function(config){config=config||{};Ext.applyIf(config,{url:Tickets.config.connector_url,baseParams:{action:'mgr/thread/getlist',},fields:this.getFields(),columns:this.getColumns(config),tbar:this.getTopBar(config),listeners:this.getListeners(config),sm:new Ext.grid.CheckboxSelectionModel(),autoHeight:true,paging:true,remoteSort:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls=[];if(rec.data.closed){cls.push('tickets-row-unpublished');}
if(rec.data.deleted){cls.push('tickets-row-deleted');}
return cls.join(' ');},},stateful:true,stateId:'tickets-threads-state',});Tickets.grid.Threads.superclass.constructor.call(this,config);this.getStore().sortInfo={field:'createdon',direction:'DESC'};};Ext.extend(Tickets.grid.Threads,MODx.grid.Grid,{getFields:function(config){return['id','resource','name','createdon','createdby','deletedon','deletedby','closed','deleted','pagetitle','comments','url','actions',];},getColumns:function(config){return[{header:_('id'),dataIndex:'id',width:35,sortable:true,},{header:_('ticket_thread_name'),dataIndex:'name',width:100,sortable:true,},{header:_('ticket_thread_createdon'),dataIndex:'createdon',width:75,sortable:true,renderer:Tickets.utils.formatDate,},{header:_('ticket_thread_comments'),dataIndex:'comments',width:75,sortable:true,},{header:_('ticket'),dataIndex:'pagetitle',width:75,renderer:function(value,metaData,record){return Tickets.utils.ticketLink(value,record['data']['resource'],true)},sortable:true,},{header:_('ticket_actions'),dataIndex:'actions',renderer:Tickets.utils.renderActions,sortable:false,width:75,id:'actions'}];},getTopBar:function(config){return['->',{xtype:'tickets-field-search',width:250,listeners:{search:{fn:function(field){this._doSearch(field);},scope:this},clear:{fn:function(field){field.setValue('');this._clearSearch();},scope:this},}}];},getListeners:function(config){return{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.viewThread(grid,e,row);}};},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=Tickets.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
return this.processEvent('click',e);},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);},_clearSearch:function(){this.getStore().baseParams.query='';this.getBottomToolbar().changePage(1);},threadAction:function(method){var ids=this._getSelectedIds();if(!ids.length){return false;}
MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/thread/multiple',method:method,ids:Ext.util.JSON.encode(ids),},listeners:{success:{fn:function(){this.refresh();},scope:this},failure:{fn:function(response){MODx.msg.alert(_('error'),response.message);},scope:this},}})},deleteThread:function(btn,e){this.threadAction('delete');},undeleteThread:function(btn,e){this.threadAction('undelete');},closeThread:function(btn,e){this.threadAction('close');},openThread:function(btn,e){this.threadAction('open');},removeThread:function(btn,e){Ext.MessageBox.confirm(_('ticket_thread_remove'),_('ticket_thread_remove_confirm'),function(val){if(val=='yes'){this.threadAction('remove');}},this);},viewThread:function(btn,e,row){var record=typeof(row)!='undefined'?row.data:this.menu.record;var w=MODx.load({xtype:'tickets-window-thread',title:record.name,threads:record.id,});w.show(e.target);},_getSelectedIds:function(){var ids=[];var selected=this.getSelectionModel().getSelections();for(var i in selected){if(!selected.hasOwnProperty(i)){continue;}
ids.push(selected[i]['id']);}
return ids;},});Ext.reg('tickets-grid-threads',Tickets.grid.Threads);;Tickets.window.Thread=function(config){config=config||{};Ext.applyIf(config,{title:_('tickets_thread'),url:Tickets.config.connector_url,items:this.getItems(config),buttons:this.getButtons(config),width:700,layout:'anchor',autoHeight:true,cls:'tickets-window '+(MODx.modx23?'modx23':'modx22'),});Tickets.window.Thread.superclass.constructor.call(this,config);};Ext.extend(Tickets.window.Thread,MODx.Window,{getItems:function(config){return[{xtype:'tickets-grid-comments',section:config.section,parents:config.parents,threads:config.threads,pageSize:5,cls:!MODx.modx23?'main-wrapper':'',}];},getButtons:function(config){return[{text:_('close'),scope:this,handler:function(){config.closeAction!=='close'?this.hide():this.close();}}]},});Ext.reg('tickets-window-thread',Tickets.window.Thread);;Tickets.grid.Comments=function(config){config=config||{};Ext.applyIf(config,{url:Tickets.config.connector_url,baseParams:{action:'mgr/comment/getlist',section:config.section,parents:config.parents,threads:config.threads,},fields:this.getFields(),columns:this.getColumns(config),tbar:this.getTopBar(config),listeners:this.getListeners(config),sm:new Ext.grid.CheckboxSelectionModel(),autoHeight:true,paging:true,remoteSort:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls=[];if(!rec.data.published){cls.push('tickets-row-unpublished');}
if(rec.data.deleted){cls.push('tickets-row-deleted');}
return cls.join(' ');},},stateful:true,stateId:'tickets-comments-state',});Tickets.grid.Comments.superclass.constructor.call(this,config);this.getStore().sortInfo={field:'createdon',direction:'DESC'};};Ext.extend(Tickets.grid.Comments,MODx.grid.Grid,{getFields:function(config){return['id','text','name','parent','email','ip','thread_name','createdby','createdon','editedon','editedby','deletedon','deletedby','published','deleted','resource','pagetitle','preview_url','actions',];},getColumns:function(config){return[{header:_('id'),dataIndex:'id',width:35,sortable:true,},{header:_('ticket_comment_text'),dataIndex:'text',width:100,sortable:true},{header:_('ticket_comment_name'),dataIndex:'name',sortable:true,width:75,renderer:function(value,metaData,record){return Tickets.utils.userLink(value,record['data']['createdby'])},},{header:_('ticket_comment_createdon'),dataIndex:'createdon',width:75,sortable:true,renderer:Tickets.utils.formatDate},{header:_('ticket'),dataIndex:'pagetitle',width:75,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.ticketLink(value,record['data']['resource'],true)},hidden:config.parents||config.threads?1:0},{header:_('ticket_comment_thread'),dataIndex:'thread_name',width:75,sortable:true,hidden:config.threads!=''&&config.threads!=0,},{header:_('ticket_actions'),dataIndex:'actions',renderer:Tickets.utils.renderActions,sortable:false,width:75,id:'actions'}];},getTopBar:function(config){return['->',{xtype:'tickets-field-search',width:250,listeners:{search:{fn:function(field){this._doSearch(field);},scope:this},clear:{fn:function(field){field.setValue('');this._clearSearch();},scope:this},}}];},getListeners:function(config){return{rowDblClick:function(grid,rowIndex,e){var row=grid.store.getAt(rowIndex);this.editComment(grid,e,row);}};},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=Tickets.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},onClick:function(e){var elem=e.getTarget();if(elem.nodeName=='BUTTON'){var row=this.getSelectionModel().getSelected();if(typeof(row)!='undefined'){var action=elem.getAttribute('action');if(action=='showMenu'){var ri=this.getStore().find('id',row.id);return this._showMenu(this,ri,e);}
else if(typeof this[action]==='function'){this.menu.record=row.data;return this[action](this,e);}}}
return this.processEvent('click',e);},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);},_clearSearch:function(){this.getStore().baseParams.query='';this.getBottomToolbar().changePage(1);},editComment:function(btn,e,row){var record=typeof(row)!='undefined'?row.data:this.menu.record;MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/comment/get',id:record.id,},listeners:{success:{fn:function(r){var record=r.object;var w=MODx.load({xtype:'tickets-window-comment-update',record:record,listeners:{success:{fn:this.refresh,scope:this},},});w.fp.getForm().reset();w.fp.getForm().setValues(record);w.show(e.target);},scope:this}}});},viewComment:function(btn,e){window.open(this.menu.record['preview_url']+'#comment-'+this.menu.record['id']);return false;},commentAction:function(method){var ids=this._getSelectedIds();if(!ids.length){return false;}
MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/comment/multiple',method:method,ids:Ext.util.JSON.encode(ids),},listeners:{success:{fn:function(){this.refresh();},scope:this},failure:{fn:function(response){MODx.msg.alert(_('error'),response.message);},scope:this},}})},publishComment:function(btn,e){this.commentAction('publish');},unpublishComment:function(btn,e){this.commentAction('unpublish');},deleteComment:function(btn,e){this.commentAction('delete');},undeleteComment:function(btn,e){this.commentAction('undelete');},removeComment:function(){Ext.MessageBox.confirm(_('ticket_comment_remove'),_('ticket_comment_remove_confirm'),function(val){if(val=='yes'){this.commentAction('remove');}},this);},_getSelectedIds:function(){var ids=[];var selected=this.getSelectionModel().getSelections();for(var i in selected){if(!selected.hasOwnProperty(i)){continue;}
ids.push(selected[i]['id']);}
return ids;},remove:function(){},});Ext.reg('tickets-grid-comments',Tickets.grid.Comments);;Tickets.window.UpdateComment=function(config){config=config||{};Ext.applyIf(config,{title:_('tickets_comment_update'),url:Tickets.config.connector_url,action:'mgr/comment/update',fields:this.getFields(config),keys:this.getKeys(config),width:700,height:550,layout:'anchor',autoHeight:false,cls:'tickets-window '+(MODx.modx23?'modx23':'modx22'),});Tickets.window.UpdateComment.superclass.constructor.call(this,config);};Ext.extend(Tickets.window.UpdateComment,MODx.Window,{getKeys:function(){return[{key:Ext.EventObject.ENTER,shift:true,fn:this.submit,scope:this}];},getFields:function(config){return[{xtype:'hidden',name:'id',},{xtype:'textarea',fieldLabel:_('comment'),name:'text',anchor:'99% -210'},{items:[{layout:'form',cls:'modx-panel',items:[{layout:'column',border:false,items:[{columnWidth:.5,border:false,layout:'form',items:this.getLeftFields(config),},{columnWidth:.5,border:false,layout:'form',cls:'right-column',items:this.getRightFields(config),}]}]}]}];},getLeftFields:function(config){return[{xtype:'textfield',fieldLabel:_('ticket_comment_name'),name:'name',anchor:'99%',disabled:config.record.createdby!=0},{xtype:'numberfield',fieldLabel:_('ticket_comment_parent'),name:'parent',anchor:'75%'},{xtype:'tickets-combo-thread',fieldLabel:_('ticket_thread'),name:'thread',anchor:'75%'}];},getRightFields:function(config){return[{xtype:'textfield',fieldLabel:_('ticket_comment_email'),name:'email',anchor:'99%',disabled:config.record.createdby!=0},{layout:'column',border:false,items:[{columnWidth:.5,border:false,layout:'form',items:[{xtype:'displayfield',fieldLabel:_('ticket_comment_createdon'),name:'createdon',anchor:'99%',},{xtype:'displayfield',fieldLabel:'IP',name:'ip',anchor:'99%',}]},{columnWidth:.5,border:false,layout:'form',cls:'right-column',items:[{xtype:'displayfield',fieldLabel:_('ticket_comment_editedon'),name:'editedon',anchor:'99%',},{xtype:'displayfield',fieldLabel:_('ticket_comment_deletedon'),name:'deletedon',anchor:'99%',}]}]}];}});Ext.reg('tickets-window-comment-update',Tickets.window.UpdateComment);;Tickets.panel.Comments=function(config){config=config||{};Ext.applyIf(config,{layout:'anchor',border:false,anchor:'100%',items:[{xtype:'tickets-grid-comments',cls:'main-wrapper',section:config.section||0,parents:config.parents||0,threads:config.threads||0,}],cls:MODx.modx23?'modx23':'modx22',});Tickets.panel.Comments.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Comments,MODx.Panel);Ext.reg('tickets-panel-comments',Tickets.panel.Comments);;Tickets.panel.Authors=function(config){config=config||{};Ext.applyIf(config,{layout:'anchor',border:false,anchor:'100%',items:[{xtype:'tickets-grid-authors',cls:'main-wrapper',}],cls:MODx.modx23?'modx23':'modx22',});Tickets.panel.Authors.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Authors,MODx.Panel);Ext.reg('tickets-panel-authors',Tickets.panel.Authors);;Tickets.grid.Authors=function(config){config=config||{};Ext.applyIf(config,{url:Tickets.config.connector_url,baseParams:{action:'mgr/author/getlist',},fields:this.getFields(),columns:this.getColumns(config),tbar:this.getTopBar(config),listeners:this.getListeners(config),autoHeight:true,paging:true,remoteSort:true,viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(rec,ri,p){var cls=[];if(rec.data.active!=1){cls.push('tickets-row-unpublished');}
if(rec.data.blocked==1){cls.push('tickets-row-deleted');}
return cls.join(' ');},},stateful:true,stateId:'tickets-authors-state',});Tickets.grid.Authors.superclass.constructor.call(this,config);this.getStore().sortInfo={field:'rating',direction:'DESC'};};Ext.extend(Tickets.grid.Authors,MODx.grid.Grid,{getFields:function(config){return['id','fullname','createdon','visitedon','active','blocked','rating','tickets','comments','views','stars','votes_tickets','votes_comments','stars_tickets','stars_comments','votes_tickets_up','votes_tickets_down','votes_comments_up','votes_comments_down',];},getColumns:function(config){var columns=[{header:_('id'),dataIndex:'id',width:35,sortable:true,},{header:_('ticket_author'),dataIndex:'fullname',width:100,sortable:true,renderer:function(value,metaData,record){return Tickets.utils.userLink(value,record['data']['id'])},},{header:_('ticket_author_createdon'),dataIndex:'createdon',width:75,sortable:true,renderer:Tickets.utils.formatDate,},{header:_('ticket_author_visitedon'),dataIndex:'visitedon',width:75,sortable:true,renderer:Tickets.utils.formatDate,}];var add={rating:{header:'<i class="'+(MODx.modx23?'icon icon-star-half-o':'fa fa-star-half-o')+'">',},tickets:{header:'<i class="'+(MODx.modx23?'icon icon-files-o':'fa fa-files-o')+'">',},comments:{header:'<i class="'+(MODx.modx23?'icon icon-comments-o':'fa fa-comments-o')+'">',},views:{header:'<i class="'+(MODx.modx23?'icon icon-eye':'fa fa-eye')+'">',},votes_tickets:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa fa-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-file-o':'fa fa-file-o')+'">',renderer:{fn:function(value,metaData,record){return this._renderRating(value,record,'tickets')},scope:this}},votes_comments:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa fa-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-comment-o':'fa fa-comment-o')+'">',renderer:{fn:function(value,metaData,record){return this._renderRating(value,record,'comments')},scope:this}},stars:{header:'<i class="'+(MODx.modx23?'icon icon-star':'fa fa-star')+'">',renderer:{fn:function(value,metaData,record){return this._renderStars(record)},scope:this},},stars_tickets:{header:'<i class="'+(MODx.modx23?'icon icon-star':'fa icon-star')+'"> '+'<i class="'+(MODx.modx23?'icon icon-file-o':'fa fa-file-o')+'">',hidden:true},stars_comments:{header:'<i class="'+(MODx.modx23?'icon icon-star':'fa icon-star')+'"> '+'<i class="'+(MODx.modx23?'icon icon-comment-o':'fa fa-comment-o')+'">',hidden:true},votes_tickets_up:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa icon-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-file-o':'fa fa-file-o')+'"> '+'<i class="'+(MODx.modx23?'icon icon-arrow-up':'fa fa-arrow-up')+'">',hidden:true},votes_tickets_down:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa icon-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-file-o':'fa fa-file-o')+'"> '+'<i class="'+(MODx.modx23?'icon icon-arrow-down':'fa fa-arrow-down')+'">',hidden:true,},votes_comments_up:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa icon-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-comment-o':'fa fa-comment-o')+'"> '+'<i class="'+(MODx.modx23?'icon icon-arrow-up':'fa fa-arrow-up')+'">',hidden:true,},votes_comments_down:{header:'<i class="'+(MODx.modx23?'icon icon-thumbs-up':'fa icon-thumbs-up')+'"> '+'<i class="'+(MODx.modx23?'icon icon-comment-o':'fa fa-comment-o')+'"> '+'<i class="'+(MODx.modx23?'icon icon-arrow-down':'fa fa-arrow-down')+'">',hidden:true,},};for(var i in add){if(!add.hasOwnProperty(i)){continue;}
columns.push(Ext.apply({header:_('ticket_author_'+i),tooltip:_('ticket_author_'+i),dataIndex:i,width:35,sortable:true,},add[i]));}
return columns;},getTopBar:function(config){return[{text:(MODx.modx23?'<i class="icon icon-refresh"></i> ':'<i class="fa fa-refresh"></i> ')
+_('ticket_authors_rebuild'),handler:this.rebuildRating,scope:this,},'->',{xtype:'tickets-field-search',width:250,listeners:{search:{fn:function(field){this._doSearch(field);},scope:this},clear:{fn:function(field){field.setValue('');this._clearSearch();},scope:this},}}];},getListeners:function(config){return{};},getMenu:function(grid,rowIndex){var ids=this._getSelectedIds();var row=grid.getStore().getAt(rowIndex);var menu=Tickets.utils.getMenu(row.data['actions'],this,ids);this.addContextMenuItem(menu);},_doSearch:function(tf){this.getStore().baseParams.query=tf.getValue();this.getBottomToolbar().changePage(1);},_clearSearch:function(){this.getStore().baseParams.query='';this.getBottomToolbar().changePage(1);},rebuildRating:function(){Ext.MessageBox.confirm(_('ticket_authors_rebuild'),_('ticket_authors_rebuild_confirm'),function(val){if(val=='yes'){this._rebuildRating(0);}},this);},_rebuildRating:function(start){if(!this._wait){this._wait=Ext.MessageBox.wait(_('ticket_authors_rebuild_wait'),_('please_wait'));}
MODx.Ajax.request({url:Tickets.config.connector_url,params:{action:'mgr/author/rebuild',start:start||0,},listeners:{success:{fn:function(response){if(response.object['total']==response.object['processed']){this._wait.hide();this._wait=null;this.refresh();}
else{this._wait.updateText(_('ticket_authors_rebuild_wait_ext').replace('[[+processed]]',response.object['processed']).replace('[[+total]]',response.object['total']));this._rebuildRating(response.object['processed']);}},scope:this}}});},_renderRating:function(value,record,type){var up=record.data['votes_'+type+'_up'];var down=record.data['votes_'+type+'_down'];return value||up||down?value+'<div><small title="'+_('ticket_author_rating_desc')+'">'+
up+' / '+down+'</small></div>':'-';},_renderStars:function(record){var tickets=record.data['stars_tickets'];var comments=record.data['stars_comments'];return tickets||comments?'<div title="'+_('ticket_author_stars_desc')+'">'+
tickets+' / '+comments+'</div>':'-';},_wait:null,});Ext.reg('tickets-grid-authors',Tickets.grid.Authors);;Tickets.page.Home=function(config){config=config||{};Ext.applyIf(config,{components:[{xtype:'tickets-panel-home',renderTo:'tickets-panel-home-div',baseCls:'tickets-formpanel',}]});Tickets.page.Home.superclass.constructor.call(this,config);};Ext.extend(Tickets.page.Home,MODx.Component);Ext.reg('tickets-page-home',Tickets.page.Home);Tickets.panel.Home=function(config){config=config||{};Ext.apply(config,{border:false,items:[{html:'<h2>'+_('tickets')+'</h2>',border:false,cls:'modx-page-header container',},{xtype:'modx-tabs',id:'tickets-home-tabs',defaults:{border:false,autoHeight:true},border:true,stateful:true,stateId:'tickets-home-panel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};},hideMode:'offsets',items:[{title:_('comments'),layout:'anchor',items:[{html:_('ticket_comments_intro'),border:false,bodyCssClass:'panel-desc',},{xtype:'tickets-panel-comments',preventRender:true,}]},{title:_('threads'),layout:'anchor',items:[{html:_('ticket_threads_intro'),border:false,bodyCssClass:'panel-desc',},{xtype:'tickets-panel-threads',preventRender:true,}]},{title:_('tickets'),layout:'anchor',items:[{html:_('ticket_tickets_intro'),border:false,bodyCssClass:'panel-desc',},{xtype:'tickets-panel-tickets',preventRender:true,}]},{title:_('authors'),layout:'anchor',items:[{html:_('ticket_authors_intro'),border:false,bodyCssClass:'panel-desc',},{xtype:'tickets-panel-authors',preventRender:true,}]}]}]});Tickets.panel.Home.superclass.constructor.call(this,config);};Ext.extend(Tickets.panel.Home,MODx.Panel);Ext.reg('tickets-panel-home',Tickets.panel.Home);
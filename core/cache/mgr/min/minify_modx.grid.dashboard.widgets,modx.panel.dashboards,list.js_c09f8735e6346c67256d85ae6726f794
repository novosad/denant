MODx.grid.DashboardWidgets=function(config){config=config||{};this.exp=new Ext.grid.RowExpander({tpl:new Ext.Template('<p class="desc">{description_trans}</p>')});this.sm=new Ext.grid.CheckboxSelectionModel();Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'system/dashboard/widget/getlist'},fields:['id','name','name_trans','description','description_trans','type','content','namespace','lexicon','size','cls'],paging:true,remoteSort:true,sm:this.sm,plugins:[this.exp],columns:[this.exp,this.sm,{header:_('id'),dataIndex:'id',width:50,sortable:true},{header:_('name'),dataIndex:'name_trans',width:150,sortable:true,editable:false},{header:_('widget_type'),dataIndex:'type',width:80,sortable:true},{header:_('widget_namespace'),dataIndex:'namespace',width:120,sortable:true}],tbar:[{text:_('widget_create'),cls:'primary-button',handler:this.createDashboard,scope:this},{text:_('bulk_actions'),menu:[{text:_('selected_remove'),handler:this.removeSelected,scope:this}]},'->',{xtype:'textfield',name:'search',id:'modx-dashboard-widget-search',cls:'x-form-filter',emptyText:_('search_ellipsis'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:this.blur,scope:cmp});},scope:this}}},{xtype:'button',text:_('filter_clear'),id:'modx-dashboard-widgets-filter-clear',cls:'x-form-filter-clear',listeners:{'click':{fn:this.clearFilter,scope:this}}}]});MODx.grid.DashboardWidgets.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.DashboardWidgets,MODx.grid.Grid,{getMenu:function(){var r=this.getSelectionModel().getSelected();var p=r.data.cls;var m=[];if(this.getSelectionModel().getCount()>1){m.push({text:_('selected_remove'),handler:this.removeSelected,scope:this});}else{if(p.indexOf('pupdate')!=-1){m.push({text:_('widget_update'),handler:this.updateWidget});}
if(p.indexOf('premove')!=-1){if(m.length>0)m.push('-');m.push({text:_('widget_unplace'),handler:this.removeWidget});}}
if(m.length>0){this.addContextMenuItem(m);}},createDashboard:function(){MODx.loadPage('system/dashboards/widget/create');},removeSelected:function(){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.msg.confirm({title:_('widget_remove_multiple'),text:_('widget_remove_multiple_confirm'),url:this.config.url,params:{action:'system/dashboard/widget/removeMultiple',widgets:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},removeWidget:function(){MODx.msg.confirm({title:_('widget_remove'),text:_('widget_remove_confirm'),url:this.config.url,params:{action:'system/dashboard/widget/remove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},updateWidget:function(){MODx.loadPage('system/dashboards/widget/update','id='+this.menu.record.id);},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.query=Ext.isEmpty(nv)||Ext.isObject(nv)?'':nv;this.getBottomToolbar().changePage(1);return true;},clearFilter:function(){this.getStore().baseParams={action:'system/dashboard/widget/getlist'};Ext.getCmp('modx-dashboard-widget-search').reset();this.getBottomToolbar().changePage(1);}});Ext.reg('modx-grid-dashboard-widgets',MODx.grid.DashboardWidgets);;MODx.panel.Dashboards=function(config){config=config||{};Ext.applyIf(config,{id:'modx-panel-dashboards',cls:'container',defaults:{collapsible:false,autoHeight:true},items:[{html:'<h2>'+_('dashboards')+'</h2>',border:false,id:'modx-dashboards-header',cls:'modx-page-header'},MODx.getPageStructure([{layout:'form',title:_('dashboards'),items:[{html:'<p>'+_('dashboards.intro_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-dashboards',cls:'main-wrapper',preventRender:true}]},{layout:'form',title:_('widgets'),items:[{html:'<p>'+_('widgets.intro_msg')+'</p>',bodyCssClass:'panel-desc',border:false},{xtype:'modx-grid-dashboard-widgets',cls:'main-wrapper',preventRender:true}]}],{stateful:true,stateId:'modx-dashboards-tabpanel',stateEvents:['tabchange'],getState:function(){return{activeTab:this.items.indexOf(this.getActiveTab())};}})]});MODx.panel.Dashboards.superclass.constructor.call(this,config);};Ext.extend(MODx.panel.Dashboards,MODx.FormPanel);Ext.reg('modx-panel-dashboards',MODx.panel.Dashboards);MODx.grid.Dashboards=function(config){config=config||{};this.sm=new Ext.grid.CheckboxSelectionModel();Ext.applyIf(config,{url:MODx.config.connector_url,baseParams:{action:'system/dashboard/getlist'},fields:['id','name','description','cls'],paging:true,autosave:true,save_action:'system/dashboard/updatefromgrid',remoteSort:true,sm:this.sm,columns:[this.sm,{header:_('id'),dataIndex:'id',width:50,sortable:true},{header:_('name'),dataIndex:'name',width:150,sortable:true,editor:{xtype:'textfield',allowBlank:false}},{header:_('description'),dataIndex:'description',width:300,sortable:false,editor:{xtype:'textarea'}}],tbar:[{text:_('dashboard_create'),cls:'primary-button',handler:this.createDashboard,scope:this},{text:_('bulk_actions'),menu:[{text:_('selected_remove'),handler:this.removeSelected,scope:this}]},'->',{xtype:'modx-combo-usergroup',name:'usergroup',id:'modx-user-filter-usergroup',itemId:'usergroup',emptyText:_('user_group_filter')+'...',baseParams:{action:'security/group/getlist',addAll:true},value:'',width:200,listeners:{'select':{fn:this.filterUsergroup,scope:this}}},{xtype:'textfield',name:'search',id:'modx-dashboard-search',cls:'x-form-filter',emptyText:_('search_ellipsis'),listeners:{'change':{fn:this.search,scope:this},'render':{fn:function(cmp){new Ext.KeyMap(cmp.getEl(),{key:Ext.EventObject.ENTER,fn:function(){this.fireEvent('change',this.getValue());this.blur();return true;},scope:cmp});},scope:this}}},{xtype:'button',text:_('filter_clear'),id:'modx-filter-clear',cls:'x-form-filter-clear',listeners:{'click':{fn:this.clearFilter,scope:this}}}]});MODx.grid.Dashboards.superclass.constructor.call(this,config);};Ext.extend(MODx.grid.Dashboards,MODx.grid.Grid,{getMenu:function(){var r=this.getSelectionModel().getSelected();var p=r.data.cls;var m=[];if(this.getSelectionModel().getCount()>1){m.push({text:_('selected_remove'),handler:this.removeSelected,scope:this});}else{if(p.indexOf('pupdate')!=-1){m.push({text:_('dashboard_update'),handler:this.updateDashboard});}
if(p.indexOf('pduplicate')!=-1){m.push({text:_('dashboard_duplicate'),handler:this.duplicateDashboard});}
if(p.indexOf('premove')!=-1&&r.data.id!=1&&r.data.name!='Default'){if(m.length>0)m.push('-');m.push({text:_('dashboard_remove'),handler:this.removeDashboard});}}
if(m.length>0){this.addContextMenuItem(m);}},createDashboard:function(){MODx.loadPage('system/dashboards/create');},removeSelected:function(){var cs=this.getSelectedAsList();if(cs===false)return false;MODx.msg.confirm({title:_('dashboard_remove_multiple'),text:_('dashboard_remove_multiple_confirm'),url:this.config.url,params:{action:'system/dashboard/removeMultiple',dashboards:cs},listeners:{'success':{fn:function(r){this.getSelectionModel().clearSelections(true);this.refresh();},scope:this}}});return true;},removeDashboard:function(){MODx.msg.confirm({title:_('dashboard_remove'),text:_('dashboard_remove_confirm'),url:this.config.url,params:{action:'system/dashboard/remove',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},duplicateDashboard:function(btn,e){MODx.Ajax.request({url:this.config.url,params:{action:'system/dashboard/duplicate',id:this.menu.record.id},listeners:{'success':{fn:this.refresh,scope:this}}});},updateDashboard:function(){MODx.loadPage('system/dashboards/update','id='+this.menu.record.id);},filterUsergroup:function(cb,nv,ov){this.getStore().baseParams.usergroup=Ext.isEmpty(nv)||Ext.isObject(nv)?cb.getValue():nv;this.getBottomToolbar().changePage(1);return true;},search:function(tf,newValue,oldValue){var nv=newValue||tf;this.getStore().baseParams.query=Ext.isEmpty(nv)||Ext.isObject(nv)?'':nv;this.getBottomToolbar().changePage(1);return true;},clearFilter:function(){this.getStore().baseParams={action:'system/dashboard/getList'};Ext.getCmp('modx-dashboard-search').reset();Ext.getCmp('modx-user-filter-usergroup').reset();this.getBottomToolbar().changePage(1);}});Ext.reg('modx-grid-dashboards',MODx.grid.Dashboards);;MODx.page.Dashboards=function(config){config=config||{};Ext.applyIf(config,{components:[{xtype:'modx-panel-dashboards'}],buttons:[{text:_('help_ex'),id:'modx-abtn-help',handler:MODx.loadHelpPane}]});MODx.page.Dashboards.superclass.constructor.call(this,config);};Ext.extend(MODx.page.Dashboards,MODx.Component);Ext.reg('modx-page-dashboards',MODx.page.Dashboards);